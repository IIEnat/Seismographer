<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Realtime Seismic Map + Waveform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin: 0; font-family: system-ui, Segoe UI, Roboto, sans-serif; background: #0b0b0b; }

    header {
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:#111; color:#fff; position:sticky; top:0; z-index:10010;
    }
    header h1 { font-size:18px; margin:0; font-weight:700; }
    header .sep { opacity:.35 }
    header label, header .chip { font-size:12px; color:#ddd; }
    header select { margin-left:6px; }

    /* Layout: map top (60%), wave bottom (40%) — always visible */
    #wrap { display:flex; flex-direction:column; height: calc(100vh - 48px); min-height: 520px; }
    #mapWrap { position:relative; flex: 0 0 60vh; min-height: 320px; }
    #map { position:absolute; inset:0; }
    #waveWrap { flex: 1 1 40vh; min-height: 240px; background:#111; border-top:1px solid #222; padding:8px 8px 0; }
    #wave { width:100%; height:100%; min-height: 230px; }

    /* Overlays on top of the map (force above Leaflet controls) */
    .overlay {
      position:absolute; z-index: 10005;    /* <- was too low; now above Leaflet controls */
      background: rgba(255,255,255,.96);
      border-radius: 12px; box-shadow: 0 8px 26px rgba(0,0,0,.25);
      padding:10px 12px; color:#111;
    }
    .overlay.dark { background: rgba(20,20,20,.94); color:#eaeaea; border:1px solid #2a2a2a; }
    #legend { left:10px; bottom:10px; min-width: 170px; }
    #badges { left:10px; top:10px; display:flex; gap:6px; flex-wrap:wrap; max-width:min(92vw, 640px); }
    .badge {
      font-size:12px; padding:4px 6px; border-radius:8px; border:1px solid #555;
      background:rgba(35,35,35,.9); color:#eaeaea; white-space:nowrap; cursor:pointer;
    }

    #legend h4 { margin:0 0 6px; font-size:13px; font-weight:700; }
    #legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; font-size:12px; }
    #legend .sw { width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,.25); }
    #legend .note { margin-top:6px; font-size:11px; opacity:.8 }

    /* Tooltip above markers */
    .rmsTip { background: rgba(0,0,0,.75); color:#fff; border:none; border-radius:6px; box-shadow:0 2px 10px rgba(0,0,0,.25); }
    .rmsTip .leaflet-tooltip-content { margin:6px 8px; font-size:12px; line-height:1.2; }

    @media (max-width: 640px) {
      #mapWrap { flex-basis: 56vh; }
      #badges { max-width: 86vw; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Realtime Seismic Map</h1>
    <span class="sep">|</span>
    <div class="chip">Polling: <span id="pollMs">1000</span> ms</div>
    <label>Interval:
      <select id="pollSelect">
        <option value="250">250 ms</option>
        <option value="500">500 ms</option>
        <option value="1000" selected>1000 ms</option>
        <option value="2000">2000 ms</option>
        <option value="5000">5000 ms</option>
      </select>
    </label>
    <span class="sep">|</span>
    <label><input type="checkbox" id="toggleOverlays" checked /> Show overlays</label>
    <span class="sep">|</span>
    <div class="chip">APIs: <code>/live</code> · <code>/wave</code></div>
    <div class="chip" style="opacity:.8">Click a station to load waveform</div>
  </header>

  <div id="wrap">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="badges" class="overlay dark"></div>
      <div id="legend" class="overlay dark"></div>
    </div>
    <div id="waveWrap">
      <div id="wave"></div>
    </div>
  </div>

<script>
/* ---------------- Config ---------------- */
const LIVE_URL = '/live';
let   POLL_MS  = 1000;
const CIRCLE_RADIUS_M = 1000;

const LEVELS = [100, 300, 500, 800, 1200];
const COLORS5 = [
  {name:'Red',    hex:'#e31a1c'},
  {name:'Green',  hex:'#33a02c'},
  {name:'Blue',   hex:'#1f78b4'},
  {name:'Yellow', hex:'#ffcc00'},
  {name:'Orange', hex:'#ff7f00'}
];

const stationOrder = {};
let stationSeq = 0;
function getStationOffset(id) { if (!(id in stationOrder)) stationOrder[id] = stationSeq++; return stationOrder[id] % COLORS5.length; }
function rmsLevelIndex(rms){ let b=0,d=1/0; for(let i=0;i<LEVELS.length;i++){const di=Math.abs(rms-LEVELS[i]); if(di<d){b=i; d=di}} return b; }
function colorForStationRMS(id, rms){ const idx=rmsLevelIndex(rms); const off=getStationOffset(id); return COLORS5[(idx+off)%COLORS5.length]; }

/* ---------------- Map ---------------- */
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

const markers = {};
let firstFit = false;

function ensureMarker(s){
  if (markers[s.id]) return markers[s.id];
  const color = colorForStationRMS(s.id, s.rms).hex;
  const circle = L.circle([s.lat, s.lon], {radius:CIRCLE_RADIUS_M, color:'#222', weight:2, fillColor:color, fillOpacity:0.6}).addTo(map);
  const m = L.circleMarker([s.lat, s.lon], {radius:5, color:'#000', fillColor:'#000', fillOpacity:1, weight:1}).addTo(map);
  const tip = L.tooltip({permanent:true, direction:'top', offset:[0,-6], className:'rmsTip'})
              .setContent(`${s.id}<br/>RMS ${Number(s.rms||0).toFixed(1)}`);
  m.bindTooltip(tip).openTooltip();
  const onClick = () => loadWaveform(s.id);
  circle.on('click', onClick); m.on('click', onClick);
  markers[s.id] = {circle, marker:m, tip};
  return markers[s.id];
}

/* ---------------- Overlays ---------------- */
function renderLegend(){
  const box = document.getElementById('legend');
  let html = '<h4>RMS → Color (fixed ×5)</h4>';
  for (let i=0;i<COLORS5.length;i++){
    html += `<div class="row"><span class="sw" style="background:${COLORS5[i].hex}"></span><span>${COLORS5[i].name} → ~${LEVELS[i]}</span></div>`;
  }
  html += '<div class="note">Each station is offset by one color and cycles.</div>';
  box.innerHTML = html;
}
renderLegend();

function updateBadges(stations){
  const root = document.getElementById('badges'); root.innerHTML = '';
  for (const s of stations){
    const col = colorForStationRMS(s.id, s.rms);
    const span = document.createElement('span');
    span.className = 'badge';
    span.style.borderColor = col.hex;
    span.style.color = col.hex;
    span.textContent = `${s.id}: RMS ${s.rms != null ? s.rms.toFixed(1) : '—'} (${col.name})`;
    span.onclick = () => loadWaveform(s.id);
    root.appendChild(span);
  }
}

const toggle = document.getElementById('toggleOverlays');
toggle.addEventListener('change', () => {
  document.getElementById('legend').style.display = toggle.checked ? '' : 'none';
  document.getElementById('badges').style.display = toggle.checked ? '' : 'none';
});

/* ---------------- Poll /live ---------------- */
async function poll(){
  try {
    const res = await fetch(LIVE_URL, {cache:'no-store'}); if (!res.ok) return;
    const payload = await res.json(); const stations = payload.stations || [];
    document.getElementById('pollMs').textContent = POLL_MS;

    if (!firstFit && stations.length){
      map.fitBounds(stations.map(s => [s.lat, s.lon]), {padding:[30,30]});
      firstFit = true;
      // Auto-load first station’s waveform (ensures wave panel shows something)
      loadWaveform(stations[0].id);
    }
    for (const s of stations){
      const entry = ensureMarker(s);
      const col = colorForStationRMS(s.id, s.rms).hex;
      entry.circle.setStyle({fillColor: col});
      entry.tip.setContent(`${s.id}<br/>RMS ${Number(s.rms||0).toFixed(1)}`);
    }
    updateBadges(stations);
  } catch {}
}

let pollTimer=null;
function startPolling(){ if (pollTimer) clearInterval(pollTimer); pollTimer = setInterval(poll, POLL_MS); poll(); }
document.getElementById('pollSelect').addEventListener('change', (e)=>{ POLL_MS = parseInt(e.target.value,10); startPolling(); });

/* ---------------- Waveform bottom ---------------- */
let openId=null, lastSecKey=null;

async function loadWaveform(id){ openId=id; lastSecKey=null; await drawWave(true); }
async function drawWave(force=false){
  if (!openId) return;
  try {
    const res = await fetch(`/wave?id=${encodeURIComponent(openId)}`, {cache:'no-store'}); if (!res.ok) return;
    const data = await res.json(); if (!force && lastSecKey === data.sec_key) return;
    lastSecKey = data.sec_key;

    const fs = data.fs || 0, values = data.values || [];
    const dt = fs > 0 ? (1.0/fs) : 0.004; const t0 = new Date(data.t0_iso);
    const xs = new Array(values.length);
    for (let i=0;i<values.length;i++) xs[i] = new Date(t0.getTime() + i*dt*1000);

    const traces = [{ x: xs, y: values, type:'scatter', mode:'lines', name: openId }];
    const layout = {
      paper_bgcolor:'#111', plot_bgcolor:'#111', font:{color:'#eaeaea'},
      margin:{l:50,r:10,t:10,b:40},
      xaxis:{title:'time', rangeslider:{visible:false}, gridcolor:'#333'},
      yaxis:{title:'amplitude', gridcolor:'#333'},
      uirevision:'keep'
    };
    Plotly.react('wave', traces, layout, {responsive:true});
  } catch {}
}

// Update waveform every second
setInterval(()=>drawWave(false), 1000);

// Kick off
startPolling();
</script>
</body>
</html>
